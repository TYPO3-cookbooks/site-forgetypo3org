<?php

$redirectUrl = 'https://typo3.org/my-account/sso/forge<% if node.chef_environment != 'production' %>dev<% end %>/';

$absoluteRefererUrl = $_SERVER["HTTP_REFERER"];

if (!empty($absoluteRefererUrl) && filter_var($absoluteRefererUrl, FILTER_VALIDATE_URL)) {
	$parsedUrl = parse_url($absoluteRefererUrl);
	// host must match *.forge.typo3.org in order to set returnTo
	if (preg_match('/^[a-z0-9\.]*forge\.typo3\.org$/', $parsedUrl['host']) === 1) {
		$redirectUrl .= '?returnTo=' . rawurlencode(ltrim($parsedUrl['path'], '/'));
	}

}

header('Location: ' . $redirectUrl);
exit;